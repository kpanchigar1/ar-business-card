<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="index.css">
    <meta charset="UTF-8">

    <!-- initialising the viewport -->
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <!-- load a-frame and ar.js-->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>

    <!-- This is a hack because at the time of writing there are some distortions in the provided visuals until the  -->
    <!-- system receives a resize event. The resize event must be triggered when everything has been loaded and the  -->
    <!-- camera has been initialized. All the events I tried didn't work, so in the end I resorted using a 3 seconds -->
    <!-- time-out after the load event. When this problem will be fixed in the AR.js library, this hack won't be necessary -->
    <!-- anymore -->
    <script>
    window.onload = function(){
        setTimeout(function(){
            var resizeEvent = window.document.createEvent('UIEvents');
            resizeEvent.initUIEvent('resize', true, false, window, 0);
            window.dispatchEvent(resizeEvent);
        }, 3000);
    };
    </script>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

</head>

<body style='margin : 0px; overflow: hidden;'>
    <!-- define the scene  -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>

            <!-- defining the content to appear (avatar of john) -->
            <a-assets>
                <a-asset-item id="john" src="/models/john_in_suit.glb"></a-asset-item>
            </a-assets>

            <!-- defining the marker to scan using a .patt file -->
            <a-marker preset='custom' type='pattern'
                      url='https://startling-hummingbird-a198e7.netlify.app/marker/pattern-12.patt'>

                <!-- linking the marker to the model we want to show -->
                <a-entity gltf-model="#john" scale="1 1 1"></a-entity>
                <a-entity id="speechBubble1" position="1 0 -2" scale="8 8 8" text="value: Click me!" look-at="#john"></a-entity>
                <a-entity id="speechBubble2" position="-1 0 -2" scale="8 8 8" text="value: Click me too!" look-at="#john"></a-entity>
                <a-entity id="speechBubble3" position="0 1 -2" scale="8 8 8" text="value: And me!" look-at="#john"></a-entity>
                <a-entity id="peter" position="0 3 3" scale="3 3 3" look-at="#john">
                    <a-image src="imgs/Peterded.PNG"></a-image>
                </a-entity>
                <script>
                    window.onload = function() {
                        // Add click event listeners to the buttons
                        document.getElementById("speechBubble1").addEventListener("click", handleTouch);
                        document.getElementById("speechBubble2").addEventListener("click", handleTouch);
                        document.getElementById("speechBubble3").addEventListener("click", handleTouch);
                    };

                    // Function to handle click events on speech bubbles
                    function handleTouch(event) {
                        var targetId = event.target.id;
                        var marker = event.currentTarget.parentElement;
                        var entity = document.createElement('a-entity');
                        // Set position and rotation of entity
                        entity.setAttribute('position', '0 0 0');
                        entity.setAttribute('rotation', '0 0 0');
            
                        switch (targetId) {
                            case "speechBubble1":
                                // Define action for speech bubble 1
                                let img = document.createElement('a-image');
                                img.setAttribute('src', 'imgs/Peterdead.PNG');
                                entity.appendChild(img);
            
                                marker.appendChild(entity);
            
                                console.log("Clicked on speech bubble 1");
                                break;
                            case "speechBubble2":
                                // Define action for speech bubble 2
                                let debugImg2 = document.createElement('img');
                                debugImg2.src = "imgs/Shrek.PNG";
                                document.body.appendChild(debugImg2);
            
                                console.log("Clicked on speech bubble 2");
                                break;
                            case "speechBubble3":
                                // Define action for speech bubble 3
                                let audio = new Audio('https://startling-hummingbird-a198e7.netlify.app/js/overview.wav');
                                audio.play();
                                console.log("Clicked on speech bubble 3");
                                break;
                            default:
                                break;
                        }
                    }
                </script>     
            </a-marker>
                <script>
                    let audioPlayedCounter = false;

                    document.querySelector('a-marker').addEventListener('markerFound', function() {
                        // Checks if overview audio played already
                        if (!audioPlayedCounter) {
                            console.log("Playing overview audio");
                            let audio = new Audio('https://startling-hummingbird-a198e7.netlify.app/js/overview.wav');
                            audio.play();
                        }
                    })
                </script>
            </a-marker>
            <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
