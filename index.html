<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="description" content="John McNamara's AR Business Card">

    <!-- initialising the viewport -->
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" type="text/css" href="styles/styles.css">


    <!-- load a-frame and ar.js-->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <link rel="manifest" href="manifest.json">

    <link href="splashscreens/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
    <link href="splashscreens/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
    <link href="splashscreens/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
    <link href="splashscreens/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <link href="splashscreens/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- enabling splashscreen for all apple devices -->

    <!-- This is a hack because at the time of writing there are some distortions in the provided visuals until the  -->
    <!-- system receives a resize event. The resize event must be triggered when everything has been loaded and the  -->
    <!-- camera has been initialized. All the events I tried didn't work, so in the end I resorted using a 3 seconds -->
    <!-- time-out after the load event. When this problem will be fixed in the AR.js library, this hack won't be necessary -->
    <!-- anymore -->
    <!-- do we need this?? -->
    <script>
    window.onload = function(){
        setTimeout(function(){
            var resizeEvent = window.document.createEvent('UIEvents');
            resizeEvent.initUIEvent('resize', true, false, window, 0);
            window.dispatchEvent(resizeEvent);
        }, 3000);
    };
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>

<body style='margin : 0px; overflow: hidden;'>
    <div id="popup-container">

    </div>
    <!-- define the scene  -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
        <!-- defining the content to appear (avatar of john) -->
        <a-assets>
            <a-asset-item id="john" src="/models/66180e52d5fd9e7f95e4cbd9.glb"></a-asset-item>
            <img crossorigin="anonymous" id="emailTexture" src="https://cdn.glitch.com/6f8b5a13-fd4d-445d-b9eb-57c735d720ea%2FPostEmail.png?1528821333360">
            <img crossorigin="anonymous" id="linkedinTexture" src="https://cdn.glitch.com/6f8b5a13-fd4d-445d-b9eb-57c735d720ea%2FPostLinkedin.png?1528821333139">
        </a-assets>

        <!-- defining the marker to scan using a .patt file -->
        <a-marker camera="active:false" preset='custom' type='pattern'
                  url='https://startling-hummingbird-a198e7.netlify.app/marker/pattern-12.patt'>

            <a-entity position="-2 .5 -1.4" rotation="-45.98 -4.56 5.28" scale="0.1 .25 .2" text-geometry="bevelEnabled:true;bevelSize:0.1;bevelThickness:0.1;curveSegments:1;font:https://cdn.glitch.com/c719c986-c0c5-48b8-967c-3cd8b8aa17f3%2Fexo2Black.typeface.json?1490305922150;height:0.5;size:2;value:J O H N   M C N A M A R A" material="color:pink;metalness:0.9;roughness:0.05;sphericalEnvMap:https://cdn.glitch.com/6f8b5a13-fd4d-445d-b9eb-57c735d720ea%2FTextureMap.png?1528781398531"></a-entity>

            <!-- linking the marker to the model we want to show -->
            <a-entity gltf-model="#john" scale="2 2 2" position="0 0 0"></a-entity>

            <!-- Adding some test links -- can be replaced with speech bubbles -->
            <a-link id="email" target="_blank" class="clickable link" title="" image="" position="-2 -2 1" rotation="-67.42 0 0" scale="0.6 0.6 0.6" geometry="primitive:circle;segments:64" material="shader:portal;side:double;visible:false" link="title:." visible="false"><a-box scale="0.8 0.8 1.05" material="src:#emailTexture" position="0 0 0" radius="2" segments-height="84" rotation="-23.450000000000003 0 0" geometry="">
            </a-box></a-link>

            <a-link id="linkedin" target="_blank" class="clickable link" position="2 2 1" title="" image=""  rotation="-67.42 0 0" scale="0.6 0.6 0.6" geometry="primitive:circle;segments:64" material="shader:portal;side:double;visible:false" link="title:." visible="false"><a-box scale="0.8 0.8 1.05" material="src:#linkedinTexture" position="0 0 0" radius="2" segments-height="84" rotation="-23.450000000000003 0 0" geometry="">
            </a-box></a-link>


            <a-plane id="box1" position="-2 4 0" color="#0000FF" height="1"
                     width="2"></a-plane>
            <a-plane id="box2" position="0 6 0" color="#FF0000" height="1"
                     width="2"></a-plane>
            <a-plane id="box3" position="2 4 0" color="#00FF00" height="1"
                     width="2"></a-plane>
            <a-entity id="speechBubbleA" position="0 4 0.1" scale="5 5 5"
                      text="value: Work?" look-at="#john"></a-entity>
            <a-entity id="speechBubbleB" position="2 6 0.1" scale="5 5 5"
                      text="value: Education?" look-at="#john"
                      clickable></a-entity>
            <a-entity id="speechBubbleC" position="4 4 0.1" scale="5 5 5"
                      text="value: Hobbies?" look-at="#john"
                      clickable></a-entity>

        </a-marker>
        <a-camera>
            <a-cursor color="#ffba70" position="0 0 -1" fuse="true" fuse-timeout="2000" raycaster="objects: .link"></a-cursor>
        </a-camera>

    </a-scene>

            <script>
                window.onload = function(){
                    var popupContainer = document.getElementById('popup-container');
                    var popupBox = document.createElement('div');
                    var closeButton = document.createElement('span');
                    var startButton = document.createElement('button');

                    popupBox.className = 'popup-box';
                    closeButton.className = 'close-btn';
                    startButton.id = 'startButton';
                    startButton.innerText = 'Start';

                    popupBox.innerHTML = "<div class=popup-content><h2>Hi there!</h2><p>My name is John McNamara and I am a software engineer at IBM. I am passionate about technology and I am always looking for new challenges. If you want to know more about me, feel free to ask me anything!</p></div>";
                    closeButton.innerHTML = "&times;";

                    closeButton.addEventListener('click', function() {
                        popupContainer.removeChild(popupBox);
                    });

                    startButton.addEventListener('click', function() {
                        popupContainer.removeChild(popupBox);
                    });

                    popupBox.appendChild(closeButton);
                    popupBox.appendChild(startButton);
                    popupContainer.appendChild(popupBox);
                };


                AFRAME.registerComponent('cursor-listener', {
                    init: function(){
                        console.log("cursor-listener init");
                    }
                })

                // Function to show the hidden content after a delay
                function showContent() {
                    // Get the content element
                    var contentElement1 = document.getElementById('box1');
                    var contentElement2 = document.getElementById('box2');
                    var contentElement3 = document.getElementById('box3');
                    var contentElement4 =
                        document.getElementById('speechBubbleA');
                    var contentElement5 =
                        document.getElementById('speechBubbleB');
                    var contentElement6 =
                        document.getElementById('speechBubbleC');

                    // Show the content
                    contentElement1.style.display = 'block';
                    contentElement2.style.display = 'block';
                    contentElement3.style.display = 'block';
                    contentElement4.style.display = 'block';
                    contentElement5.style.display = 'block';
                    contentElement6.style.display = 'block';
                }

                // Call the showContent function after a delay of 2000 milliseconds (2 seconds)
                setTimeout(showContent, 2000);
                
                // TODO: add a message to the user that the camera is not supported

                let audioPlayedCounter = false;

                // Disable the raycaster component when the page loads
                document.querySelector('a-cursor').setAttribute('raycaster', 'enabled', false);

                document.querySelector('a-marker').addEventListener('markerFound', function() {
                    // Enable the raycaster component when the marker is found
                    document.querySelector('a-cursor').setAttribute('raycaster', 'enabled', true);

                    if (!audioPlayedCounter) {
                        console.log("Playing overview audio");
                        let audio = new Audio('https://startling-hummingbird-a198e7.netlify.app/audio/overview.wav');
                        audio.play();
                        console.log("Audio played")
                    }
                    audioPlayedCounter = true;

                    document.getElementById('email').setAttribute('visible', 'true');
                    document.getElementById('email').setAttribute('href', 'mailto:j0nnymac@uk.ibm.com');
                    console.log('set email visible and add href');

                    document.getElementById('linkedin').setAttribute('visible', 'true');
                    document.getElementById('linkedin').setAttribute('href', 'https://uk.linkedin.com/in/jonmcnamara');
                    console.log('set linkedin visible and add href');
                });
            </script>
        </a-marker>
</body>
</html>
